{% extends "dashboard/base_admin.html" %}
{% load humanize %}
{% load static %}
{% block title %}Server Monitor{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin_server_monitor.css' %}">
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">
      <i class="fas fa-server me-2"></i>
      Server Monitor
    </h1>
    <p class="page-subtitle">Real-time server performance and resource monitoring</p>
  </div>
</div>

<!-- Server Status Cards -->
<div class="admin-grid grid-4">
  <!-- Server Status -->
  <div class="admin-card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-heartbeat me-2 text-success"></i>
        Server Status
      </h3>
    </div>
    <div class="text-center">
      <div class="status-indicator status-success mb-3">
        <i class="fas fa-check-circle"></i>
        Online
      </div>
      <div class="row text-center">
        <div class="col-12 mb-2">
          <h3 class="fw-bold text-success mb-0" id="uptime">Loading...</h3>
          <small class="text-muted">Uptime</small>
        </div>
        <div class="col-6">
          <h5 class="fw-bold text-primary mb-0" id="response-time">45ms</h5>
          <small class="text-muted">Response</small>
        </div>
        <div class="col-6">
          <h5 class="fw-bold text-info mb-0" id="requests">1.2K</h5>
          <small class="text-muted">Requests/hr</small>
        </div>
      </div>
    </div>
  </div>

  <!-- CPU Usage -->
  <div class="admin-card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-microchip me-2 text-primary"></i>
        CPU Usage
      </h3>
    </div>
    <div class="text-center">
      <div class="position-relative d-inline-block mb-3">
        <canvas id="cpuChart" width="120" height="120"></canvas>
        <div class="position-absolute top-50 start-50 translate-middle">
          <h3 class="fw-bold mb-0" id="cpu-percentage">45%</h3>
        </div>
      </div>
      <div class="row text-center">
        <div class="col-6">
          <small class="text-muted d-block">Load Avg</small>
          <span class="fw-bold" id="load-avg">0.85</span>
        </div>
        <div class="col-6">
          <small class="text-muted d-block">Cores</small>
          <span class="fw-bold" id="cpu-cores">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Memory Usage -->
  <div class="admin-card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-memory me-2 text-warning"></i>
        Memory Usage
      </h3>
    </div>
    <div class="text-center">
      <div class="position-relative d-inline-block mb-3">
        <canvas id="memoryChart" width="120" height="120"></canvas>
        <div class="position-absolute top-50 start-50 translate-middle">
          <h3 class="fw-bold mb-0" id="memory-percentage">62%</h3>
        </div>
      </div>
      <div class="row text-center">
        <div class="col-6">
          <small class="text-muted d-block">Used</small>
          <span class="fw-bold" id="memory-used">6.2GB</span>
        </div>
        <div class="col-6">
          <small class="text-muted d-block">Total</small>
          <span class="fw-bold" id="memory-total">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Storage Usage -->
  <div class="admin-card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-hdd me-2 text-danger"></i>
        Storage Usage
      </h3>
    </div>
    <div class="text-center">
      <div class="position-relative d-inline-block mb-3">
        <canvas id="storageChart" width="120" height="120"></canvas>
        <div class="position-absolute top-50 start-50 translate-middle">
          <h3 class="fw-bold mb-0" id="storage-percentage">78%</h3>
        </div>
      </div>
      <div class="row text-center">
        <div class="col-6">
          <small class="text-muted d-block">Used</small>
          <span class="fw-bold" id="storage-used">156GB</span>
        </div>
        <div class="col-6">
          <small class="text-muted d-block">Total</small>
          <span class="fw-bold" id="storage-total">-</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Performance Charts -->
<div class="admin-grid grid-2">
  <!-- Real-time Performance -->
  <div class="admin-card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-chart-line me-2"></i>
        Real-time Performance
      </h3>
      <div class="card-actions">
        <button class="btn-admin btn-primary btn-sm" onclick="toggleRealTime()">
          <i class="fas fa-pause" id="realtime-icon"></i>
          <span id="realtime-text">Pause</span>
        </button>
      </div>
    </div>
    <div style="height: 300px;">
      <canvas id="realtimeChart"></canvas>
    </div>
  </div>

  <!-- Network Activity -->
  <div class="admin-card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-network-wired me-2"></i>
        Network Activity
      </h3>
    </div>
    <div style="height: 300px;">
      <canvas id="networkChart"></canvas>
    </div>
  </div>
</div>

<!-- Process List -->
<div class="admin-card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-list me-2"></i>
      Top Processes
    </h3>
    <div class="card-actions">
      <button class="btn-admin btn-primary btn-sm" onclick="refreshProcesses()">
        <i class="fas fa-sync-alt"></i>
        Refresh
      </button>
    </div>
  </div>
  
  <div class="table-responsive">
    <table class="table table-sm">
      <thead>
        <tr>
          <th>PID</th>
          <th>Process</th>
          <th>User</th>
          <th>CPU %</th>
          <th>Memory %</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="processes-table">
        <tr>
          <td>1234</td>
          <td>
            <div class="d-flex align-items-center">
              <i class="fas fa-cog me-2 text-primary"></i>
              <strong>python3 manage.py runserver</strong>
            </div>
          </td>
          <td>www-data</td>
          <td>
            <div class="d-flex align-items-center">
              <div class="progress me-2" style="width: 60px; height: 6px;">
                <div class="progress-bar bg-success" style="width: 25%"></div>
              </div>
              <span>2.5%</span>
            </div>
          </td>
          <td>
            <div class="d-flex align-items-center">
              <div class="progress me-2" style="width: 60px; height: 6px;">
                <div class="progress-bar bg-warning" style="width: 45%"></div>
              </div>
              <span>4.5%</span>
            </div>
          </td>
          <td>
            <span class="status-indicator status-success">
              <i class="fas fa-play"></i>
              Running
            </span>
          </td>
          <td>
            <button class="btn-admin btn-danger btn-sm" onclick="killProcess(1234)">
              <i class="fas fa-stop"></i>
            </button>
          </td>
        </tr>
        <tr>
          <td>5678</td>
          <td>
            <div class="d-flex align-items-center">
              <i class="fas fa-database me-2 text-info"></i>
              <strong>postgres</strong>
            </div>
          </td>
          <td>postgres</td>
          <td>
            <div class="d-flex align-items-center">
              <div class="progress me-2" style="width: 60px; height: 6px;">
                <div class="progress-bar bg-success" style="width: 15%"></div>
              </div>
              <span>1.5%</span>
            </div>
          </td>
          <td>
            <div class="d-flex align-items-center">
              <div class="progress me-2" style="width: 60px; height: 6px;">
                <div class="progress-bar bg-primary" style="width: 30%"></div>
              </div>
              <span>3.0%</span>
            </div>
          </td>
          <td>
            <span class="status-indicator status-success">
              <i class="fas fa-play"></i>
              Running
            </span>
          </td>
          <td>
            <button class="btn-admin btn-danger btn-sm" onclick="killProcess(5678)">
              <i class="fas fa-stop"></i>
            </button>
          </td>
        </tr>
        <tr>
          <td>9012</td>
          <td>
            <div class="d-flex align-items-center">
              <i class="fas fa-globe me-2 text-success"></i>
              <strong>nginx</strong>
            </div>
          </td>
          <td>www-data</td>
          <td>
            <div class="d-flex align-items-center">
              <div class="progress me-2" style="width: 60px; height: 6px;">
                <div class="progress-bar bg-success" style="width: 8%"></div>
              </div>
              <span>0.8%</span>
            </div>
          </td>
          <td>
            <div class="d-flex align-items-center">
              <div class="progress me-2" style="width: 60px; height: 6px;">
                <div class="progress-bar bg-primary" style="width: 12%"></div>
              </div>
              <span>1.2%</span>
            </div>
          </td>
          <td>
            <span class="status-indicator status-success">
              <i class="fas fa-play"></i>
              Running
            </span>
          </td>
          <td>
            <button class="btn-admin btn-danger btn-sm" onclick="killProcess(9012)">
              <i class="fas fa-stop"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Set global variables for JavaScript
window.serverMonitorConfig = {
    username: '{{ username }}',
    serverMetricsUrl: '/dashboard/api/server-metrics/',
    csrfToken: '{{ csrf_token }}'
};
</script>
<script src="{% static 'js/admin_server_monitor.js' %}"></script>
{% endblock %}
