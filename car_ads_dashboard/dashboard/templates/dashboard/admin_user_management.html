{% extends "dashboard/base_admin.html" %}
{% load humanize %}
{% load static %}
{% block title %}User Management{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin_user_management.css' %}">
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">
      <i class="fas fa-users-cog me-2"></i>
      User Management
    </h1>
    <p class="page-subtitle">Manage users, roles, and permissions</p>
  </div>
  <div class="page-actions">
    <button class="btn-admin btn-primary" onclick="showCreateUserModal()">
      <i class="fas fa-user-plus"></i>
      Add New User
    </button>
  </div>
</div>

<!-- Statistics Cards -->
<div class="admin-grid grid-4">
  <div class="admin-card">
    <div class="card-header">
      <h4 class="card-title text-primary">
        <i class="fas fa-users"></i>
        Total Users
      </h4>
    </div>
    <div class="stat-value">{{ stats.total_users }}</div>
  </div>
  
  <div class="admin-card">
    <div class="card-header">
      <h4 class="card-title text-warning">
        <i class="fas fa-clock"></i>
        Pending Approval
      </h4>
    </div>
    <div class="stat-value">{{ stats.pending_users }}</div>
  </div>
  
  <div class="admin-card">
    <div class="card-header">
      <h4 class="card-title text-success">
        <i class="fas fa-check-circle"></i>
        Active Users
      </h4>
    </div>
    <div class="stat-value">{{ stats.approved_users }}</div>
  </div>
  
  <div class="admin-card">
    <div class="card-header">
      <h4 class="card-title text-danger">
        <i class="fas fa-user-slash"></i>
        Inactive Users
      </h4>
    </div>
    <div class="stat-value">{{ stats.inactive_users }}</div>
  </div>
</div>

<!-- Filters and Search -->
<div class="admin-card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-filter me-2"></i>
      Filters & Search
    </h3>
  </div>
  
  <form method="GET" class="filter-form">
    <div class="row">
      <div class="col-md-3">
        <label for="status" class="form-label">Status</label>
        <select name="status" id="status" class="form-select">
          <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
          <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending Approval</option>
          <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Active Users</option>
          <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive Users</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="role" class="form-label">Role</label>
        <select name="role" id="role" class="form-select">
          <option value="all" {% if role_filter == 'all' %}selected{% endif %}>All Roles</option>
          <option value="user" {% if role_filter == 'user' %}selected{% endif %}>User</option>
          <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Admin</option>
          {% if current_user_profile.is_super_admin %}
            <option value="super_admin" {% if role_filter == 'super_admin' %}selected{% endif %}>Super Admin</option>
          {% endif %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="search" class="form-label">Search</label>
        <input type="text" name="search" id="search" class="form-control" 
               placeholder="Search by username, email, or name..." 
               value="{{ search_query }}">
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn-admin btn-primary me-2">
          <i class="fas fa-search"></i>
          Filter
        </button>
        <a href="{% url 'admin_user_management' username=username %}" class="btn-admin btn-secondary">
          <i class="fas fa-times"></i>
          Clear
        </a>
      </div>
    </div>
  </form>
</div>

<!-- Users Table -->
<div class="admin-card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-table me-2"></i>
      Users ({{ page_obj.paginator.count }} total)
    </h3>
  </div>
  
  <div class="table-responsive">
    {% if users %}
      <table class="table table-hover">
        <thead>
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Registration Date</th>
            <th>Last Login</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user_data in user_list %}
            <tr data-user-id="{{ user_data.user.id }}" data-username="{{ user_data.user.username }}">
              <td>
                <div class="d-flex align-items-center">
                  <div class="user-avatar me-3" style="width: 40px; height: 40px; font-size: 1rem;">
                    {{ user_data.user.first_name|first|upper|default:user_data.user.username|first|upper }}
                  </div>
                  <div>
                    <strong>{{ user_data.user.username }}</strong>
                    <br>
                    <small class="text-muted">{{ user_data.user.first_name }} {{ user_data.user.last_name }}</small>
                  </div>
                </div>
              </td>
              <td>{{ user_data.user.email }}</td>
              <td>
                {% if user_data.profile.is_super_admin %}
                  <span class="badge bg-danger">Super Admin</span>
                {% elif user_data.user.groups.all %}
                  {% for group in user_data.user.groups.all %}
                    <span class="badge bg-{% if group.name == 'Admin' %}warning{% else %}info{% endif %}">{{ group.name }}</span>
                  {% endfor %}
                {% else %}
                  <span class="badge bg-secondary">No Role</span>
                {% endif %}
              </td>
              <td>
                {% if not user_data.profile.is_approved %}
                  <span class="status-indicator status-warning">
                    <i class="fas fa-clock"></i>
                    Pending Approval
                  </span>
                {% elif not user_data.user.is_active %}
                  <span class="status-indicator status-danger">
                    <i class="fas fa-times-circle"></i>
                    Inactive
                  </span>
                {% else %}
                  <span class="status-indicator status-success">
                    <i class="fas fa-check-circle"></i>
                    Active
                  </span>
                {% endif %}
              </td>
              <td>
                <span class="text-muted">{{ user_data.user.date_joined|date:"M d, Y" }}</span>
                <br>
                <small class="text-muted">{{ user_data.user.date_joined|timesince }} ago</small>
              </td>
              <td>
                {% if user_data.user.last_login %}
                  <span class="text-muted">{{ user_data.user.last_login|date:"M d, Y" }}</span>
                  <br>
                  <small class="text-muted">{{ user_data.user.last_login|timesince }} ago</small>
                {% else %}
                  <span class="text-muted">Never</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group" role="group">
                  <button class="btn-admin btn-info btn-sm" onclick="viewUserDetails('{{ user_data.user.username }}')">
                    <i class="fas fa-eye"></i>
                  </button>
                  
                  {% if not user_data.profile.is_approved %}
                    <button class="btn-admin btn-success btn-sm" onclick="approveUser('{{ user_data.user.username }}')">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn-admin btn-danger btn-sm" onclick="rejectUser('{{ user_data.user.username }}')">
                      <i class="fas fa-times"></i>
                    </button>
                  {% endif %}
                  
                  {% if user_data.user.username != username %}
                    {% comment %} Check if current user can manage this target user {% endcomment %}
                    {% if user_data.can_manage %}
                      <button class="btn-admin btn-warning btn-sm" onclick="toggleUserStatus('{{ user_data.user.username }}', {{ user_data.user.is_active|yesno:'false,true' }})">
                        <i class="fas fa-{% if user_data.user.is_active %}pause{% else %}play{% endif %}"></i>
                      </button>
                      
                      <div class="dropdown">
                        <button class="btn-admin btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                          <i class="fas fa-cog"></i>
                        </button>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#" onclick="showEditUserModal('{{ user_data.user.username }}')">
                            <i class="fas fa-edit"></i> Edit Profile</a></li>
                          {% if not user_data.profile.is_super_admin or current_user_profile.is_super_admin %}
                            <li><a class="dropdown-item" href="#" onclick="showResetPasswordModal('{{ user_data.user.username }}')">
                              <i class="fas fa-key"></i> Reset Password</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showChangeRoleModal('{{ user_data.user.username }}')">
                              <i class="fas fa-user-tag"></i> Change Role</a></li>
                          {% endif %}
                          <li><hr class="dropdown-divider"></li>
                          {% if not user_data.profile.is_super_admin or current_user_profile.is_super_admin %}
                            <li><a class="dropdown-item text-danger" href="#" onclick="showDeleteUserModal('{{ user_data.user.username }}')">
                              <i class="fas fa-trash"></i> Delete User</a></li>
                          {% endif %}
                        </ul>
                      </div>
                    {% else %}
                      <span class="badge bg-warning">Protected</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-primary">You</span>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      
      <!-- Pagination -->
      {% if page_obj.has_other_pages %}
        <nav aria-label="User pagination">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if role_filter != 'all' %}&role={{ role_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">&laquo; First</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if role_filter != 'all' %}&role={{ role_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
              </li>
            {% endif %}
            
            <li class="page-item active">
              <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>
            
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if role_filter != 'all' %}&role={{ role_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if role_filter != 'all' %}&role={{ role_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Last &raquo;</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    {% else %}
      <div class="text-center py-5">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No Users Found</h5>
        <p class="text-muted">No users match your search criteria</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-plus me-2"></i>
          Create New User
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="createUserForm">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="newUsername" class="form-label">Username *</label>
                <input type="text" class="form-control" id="newUsername" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="newEmail" class="form-label">Email *</label>
                <input type="email" class="form-control" id="newEmail" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="newFirstName" class="form-label">First Name *</label>
                <input type="text" class="form-control" id="newFirstName" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="newLastName" class="form-label">Last Name *</label>
                <input type="text" class="form-control" id="newLastName" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="newPassword" class="form-label">Password *</label>
                <input type="password" class="form-control" id="newPassword" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="newRole" class="form-label">Role *</label>
                <select class="form-select" id="newRole" required>
                  <option value="User">User</option>
                  <option value="Admin">Admin</option>
                  {% if current_user_profile.is_super_admin %}
                    <option value="Super Admin">Super Admin</option>
                  {% endif %}
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-admin btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn-admin btn-primary">
            <i class="fas fa-plus"></i>
            Create User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-edit me-2"></i>
          Edit User
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editUserForm">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editUsername" class="form-label">Username *</label>
                <input type="text" class="form-control" id="editUsername" required readonly>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editEmail" class="form-label">Email *</label>
                <input type="email" class="form-control" id="editEmail" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editFirstName" class="form-label">First Name *</label>
                <input type="text" class="form-control" id="editFirstName" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editLastName" class="form-label">Last Name *</label>
                <input type="text" class="form-control" id="editLastName" required>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-admin btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn-admin btn-primary">
            <i class="fas fa-save"></i>
            Update User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user me-2"></i>
          User Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="userDetailsContent">
        <!-- User details will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-key me-2"></i>
          Reset Password
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="resetPasswordForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="resetUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="resetUsername" readonly>
          </div>
          <div class="mb-3">
            <label for="newPasswordReset" class="form-label">New Password *</label>
            <input type="password" class="form-control" id="newPasswordReset" required>
          </div>
          <div class="mb-3">
            <label for="confirmPasswordReset" class="form-label">Confirm Password *</label>
            <input type="password" class="form-control" id="confirmPasswordReset" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-admin btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn-admin btn-warning">
            <i class="fas fa-key"></i>
            Reset Password
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Change Role Modal -->
<div class="modal fade" id="changeRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-tag me-2"></i>
          Change User Role
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="changeRoleForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="roleUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="roleUsername" readonly>
          </div>
          <div class="mb-3">
            <label for="userRole" class="form-label">New Role *</label>
            <select class="form-select" id="userRole" required>
              <option value="User">User</option>
              <option value="Admin">Admin</option>
              {% if current_user_profile.is_super_admin %}
                <option value="Super Admin">Super Admin</option>
              {% endif %}
            </select>
          </div>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> Changing user role will affect their access permissions.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-admin btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn-admin btn-warning">
            <i class="fas fa-user-tag"></i>
            Change Role
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-trash me-2"></i>
          Delete User
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="deleteUserForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="deleteUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="deleteUsername" readonly>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="permanentDelete">
              <label class="form-check-label" for="permanentDelete">
                Permanent deletion (cannot be undone)
              </label>
            </div>
            <small class="text-muted">If unchecked, user will be deactivated and can be restored later.</small>
          </div>
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action will remove the user from the system.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-admin btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn-admin btn-danger">
            <i class="fas fa-trash"></i>
            Delete User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reject User Modal -->
<div class="modal fade" id="rejectUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-times me-2"></i>
          Reject User Registration
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="rejectUserForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="rejectUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="rejectUsername" readonly>
          </div>
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action will permanently delete the user's registration and cannot be undone.
          </div>
          <div class="mb-3">
            <label for="rejectReason" class="form-label">Reason for Rejection (Optional)</label>
            <textarea class="form-control" id="rejectReason" rows="3" placeholder="Enter reason for rejection..."></textarea>
            <small class="text-muted">This reason will be logged for administrative purposes.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-admin btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn-admin btn-danger">
            <i class="fas fa-user-times"></i>
            Reject Registration
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Set global variables for JavaScript
window.userManagementConfig = {
    username: '{{ username }}',
    createUserUrl: '{% url "create_user" username=username %}',
    getUserDetailsUrl: '{% url "get_user_details" username=username %}',
    approveUserUrl: '{% url "approve_user" username=username %}',
    rejectUserUrl: '{% url "reject_user" username=username %}',
    toggleStatusUrl: '{% url "toggle_user_status" username=username %}',
    updateUserUrl: '{% url "update_user" username=username %}',
    resetPasswordUrl: '{% url "reset_user_password" username=username %}',
    updateRoleUrl: '{% url "update_user_role" username=username %}',
    deleteUserUrl: '{% url "delete_user" username=username %}',
    csrfToken: '{{ csrf_token }}'
};
</script>
<script src="{% static 'js/admin_user_management.js' %}"></script>
{% endblock %}
