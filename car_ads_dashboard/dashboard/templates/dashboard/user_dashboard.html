{% extends "dashboard/base_user.html" %}
{% load humanize %}
{% load static %}
{% block title %}Dashboard - {{ source|capfirst }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/user_dashboard.css' %}">
<div class="modern-dashboard">
  <!-- Hero Section -->
  <div class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">Dashboard Analytics</h1>
      <p class="hero-subtitle">{{ source|capfirst }} - Real-time car listing insights</p>
      <div class="hero-stats">
        <span class="stat-badge">Live Data</span>
        <span class="stat-separator">â€¢</span>
        <span class="stat-text">Updated {{ "now"|date:"H:i" }}</span>
      </div>
    </div>
    <div class="hero-decoration">
      <div class="decoration-circle primary"></div>
      <div class="decoration-circle secondary"></div>
      <div class="decoration-circle accent"></div>
    </div>
  </div>

  <!-- KPI Cards Section -->
  <div class="kpi-section">
    <div class="kpi-grid">
      <div class="kpi-card primary">
        <div class="kpi-header">
          <div class="kpi-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="kpi-trend up">
            <i class="fas fa-arrow-up"></i>
          </div>
        </div>
        <div class="kpi-content">
          <h3 class="kpi-value">{{ total_all|intcomma }}</h3>
          <p class="kpi-label">Total Semua Listing</p>
          <div class="kpi-change">+12% dari bulan lalu</div>
        </div>
      </div>

      <div class="kpi-card success">
        <div class="kpi-header">
          <div class="kpi-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="kpi-trend up">
            <i class="fas fa-arrow-up"></i>
          </div>
        </div>
        <div class="kpi-content">
          <h3 class="kpi-value">{{ total_active|intcomma }}</h3>
          <p class="kpi-label">Listing Aktif</p>
          <div class="kpi-change">+8% dari minggu lalu</div>
        </div>
      </div>

      <div class="kpi-card warning">
        <div class="kpi-header">
          <div class="kpi-icon">
            <i class="fas fa-handshake"></i>
          </div>
          <div class="kpi-trend down">
            <i class="fas fa-arrow-down"></i>
          </div>
        </div>
        <div class="kpi-content">
          <h3 class="kpi-value">{{ total_sold|intcomma }}</h3>
          <p class="kpi-label">Listing Terjual</p>
          <div class="kpi-change">-3% dari minggu lalu</div>
        </div>
      </div>

      <div class="kpi-card info">
        <div class="kpi-header">
          <div class="kpi-icon">
            <i class="fas fa-tags"></i>
          </div>
          <div class="kpi-trend neutral">
            <i class="fas fa-minus"></i>
          </div>
        </div>
        <div class="kpi-content">
          <h3 class="kpi-value">{{ total_brand|intcomma }}</h3>
          <p class="kpi-label">Total Brand</p>
          <div class="kpi-change">Stabil</div>
        </div>
      </div>

      <div class="kpi-card danger">
        <div class="kpi-header">
          <div class="kpi-icon">
            <i class="fas fa-calendar-day"></i>
          </div>
          <div class="kpi-trend up">
            <i class="fas fa-arrow-up"></i>
          </div>
        </div>
        <div class="kpi-content">
          <h3 class="kpi-value">{{ total_today|intcomma }}</h3>
          <p class="kpi-label">Data Hari Ini</p>
          <div class="kpi-change">Baru ditambahkan</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <div class="charts-grid">
      <!-- Top 10 Brands Chart -->
      <div class="chart-card full-width">
        <div class="chart-header">
          <h3 class="chart-title">Top 10 Brand Mobil</h3>
          <div class="chart-subtitle">Brand dengan listing terbanyak</div>
        </div>
        <div class="chart-content">
          <canvas id="top10BrandsChart"></canvas>
        </div>
      </div>

      <!-- Brand Active vs Sold -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Aktif vs Terjual</h3>
          <div class="chart-subtitle">Perbandingan listing per brand</div>
        </div>
        <div class="chart-content">
          <canvas id="brandChart"></canvas>
        </div>
      </div>

      <!-- Listing per Year -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Listing per Tahun</h3>
          <div class="chart-subtitle">Trend listing berdasarkan tahun</div>
        </div>
        <div class="chart-content">
          <canvas id="yearChart"></canvas>
        </div>
      </div>

      <!-- Average Price -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Harga Rata-rata</h3>
          <div class="chart-subtitle">Harga rata-rata per brand</div>
        </div>
        <div class="chart-content">
          <canvas id="priceChart"></canvas>
        </div>
      </div>

    </div>
  </div>

  <!-- Analysis Section -->
  <div class="analysis-section">
    <div class="analysis-grid">
      <!-- Scatter Plot Analysis -->
      <div class="analysis-card full-width">
        <div class="analysis-header">
          <h3 class="analysis-title">Scatter Plot Analysis</h3>
          <div class="analysis-subtitle">Hubungan antara harga dan mileage</div>
        </div>
        <div class="analysis-filters">
          <div class="filter-group">
            <label for="scatterBrand" class="filter-label">Brand:</label>
            <select id="scatterBrand" class="filter-select">
              <option value="">Semua Brand</option>
              {% for brand in scatter_brands %}
              <option value="{{ brand }}">{{ brand }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label for="scatterModel" class="filter-label">Model:</label>
            <select id="scatterModel" class="filter-select">
              <option value="">Semua Model</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="scatterVariant" class="filter-label">Variant:</label>
            <select id="scatterVariant" class="filter-select">
              <option value="">Semua Variant</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="scatterYear" class="filter-label">Year:</label>
            <select id="scatterYear" class="filter-select">
              <option value="">Semua Tahun</option>
            </select>
          </div>
        </div>
        
        <!-- Scatter Plot Statistics Panel -->
        <div class="scatter-stats-panel" id="scatterStatsPanel">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="avgPrice">-</div>
                <div class="stat-label">Average Price</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <i class="fas fa-tachometer-alt"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="avgMileage">-</div>
                <div class="stat-label">Average Mileage</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <i class="fas fa-arrow-up"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="maxPrice">-</div>
                <div class="stat-label">Maximum Price</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <i class="fas fa-arrow-down"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="minPrice">-</div>
                <div class="stat-label">Minimum Price</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <i class="fas fa-database"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="totalDataPoints">-</div>
                <div class="stat-label">Total Data Points</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <i class="fas fa-road"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="maxMileage">-</div>
                <div class="stat-label">Maximum Mileage</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="analysis-content">
          <canvas id="scatterChart"></canvas>
        </div>
      </div>

      <!-- Average Mileage per Year -->
      <div class="analysis-card full-width">
        <div class="analysis-header">
          <h3 class="analysis-title">Average Mileage per Year</h3>
          <div class="analysis-subtitle">Trend rata-rata mileage berdasarkan tahun</div>
        </div>
        <div class="analysis-content">
          <canvas id="avgMileageChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Today's Data Section -->
  <div class="today-data-section">
    <div class="today-data-grid">
      <!-- Today's Data Table -->
      <div class="today-data-card">
        <div class="today-data-header">
          <h3 class="today-data-title">
            <i class="fas fa-calendar-day"></i>
            Data Terbaru Hari Ini
          </h3>
          <div class="today-data-subtitle">Daftar data mobil terbaru hari ini</div>
        </div>
        <div class="today-data-content">
          <div class="table-responsive">
            <table id="todayDataTable" class="table table-striped table-bordered align-middle w-100">
              <thead>
                <tr>
                  <th>Img</th>
                  <th>Brand</th>
                  <th>Model</th>
                  <th>Variant</th>
                  <th>Year</th>
                  <th>Mileage (km)</th>
                  <th>Harga (RM)</th>
                  <th>Status</th>
                  <th>Waktu Update</th>
                </tr>
              </thead>
              <tbody id="todayDataTableBody">
                <tr>
                  <td colspan="9" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0">Memuat data hari ini...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Price Trends Section -->
  <div class="trends-section">
    <div class="trends-grid single-card">
      <!-- Latest Price Changes -->
      <div class="trends-card latest-changes-card">
        <div class="trends-header">
          <h3 class="trends-title">
            <i class="fas fa-clock"></i>
            Top 20 Model/Variant - Latest Price Changes
          </h3>
          <div class="trends-subtitle">Model dan variant dengan perubahan harga terbaru (status active)</div>
        </div>
        <div class="trends-content">
          {% if price_trends.latest_trends %}
            <div class="trends-list">
              {% for trend in price_trends.latest_trends %}
              <div class="trend-item {% if trend.avg_price_change_percent > 0 %}trend-up{% else %}trend-down{% endif %}" data-bs-toggle="tooltip" data-bs-placement="top" title="Klik untuk melihat detail perubahan harga">
                <div class="trend-info">
                  <div class="trend-ranking">
                    <span class="rank-number">{{ forloop.counter }}</span>
                  </div>
                  <div class="trend-details">
                    <div class="trend-main">
                      <span class="trend-brand">{{ trend.brand|default:"Unknown" }}</span>
                      <span class="trend-model">{{ trend.model|default:"Unknown" }}</span>
                      {% if trend.variant %}
                      <span class="trend-variant">{{ trend.variant }}</span>
                      {% endif %}
                    </div>
                    <div class="trend-specs">
                      {% if trend.year %}
                      <span class="trend-year">{{ trend.year }}</span>
                      {% endif %}
                      {% if trend.mileage %}
                      <span class="trend-mileage">{{ trend.mileage|intcomma }} km</span>
                      {% endif %}
                    </div>
                    <div class="trend-meta">
                      <span class="trend-condition">{{ trend.condition|default:"Unknown" }}</span>
                      <span class="trend-changes">{{ trend.total_changes }} perubahan</span>
                      {% if trend.latest_change %}
                      <span class="trend-last-update">{{ trend.latest_change|timesince }} lalu</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="trend-stats">
                  <div class="trend-percentage {% if trend.avg_price_change_percent > 0 %}up{% else %}down{% endif %}">
                    <i class="fas {% if trend.avg_price_change_percent > 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                    {% if trend.avg_price_change_percent > 0 %}+{% endif %}{{ trend.avg_price_change_percent|floatformat:1 }}%
                  </div>
                  <div class="trend-amount {% if trend.avg_price_change_percent > 0 %}up{% else %}down{% endif %}">
                    {% if trend.avg_price_change > 0 %}+{% endif %}RM {{ trend.avg_price_change|floatformat:0|intcomma }}
                  </div>
                  <div class="trend-click-hint">
                    <i class="fas fa-mouse-pointer"></i>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="trends-empty">
              <i class="fas fa-chart-line"></i>
              <p>Belum ada data tren harga</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Pass Django variables to JavaScript
window.dashboardConfig = {
  source: '{{ source }}',
  username: '{{ username }}',
  top_10_brands_labels: {{ top_10_brands_labels|safe }},
  top_10_brands_data: {{ top_10_brands_data|safe }},
  brand_labels: {{ brand_labels|safe }},
  brand_active_data: {{ brand_active_data|safe }},
  brand_sold_data: {{ brand_sold_data|safe }},
  year_labels: {{ year_labels|safe }},
  year_data: {{ year_data|safe }},
  price_labels: {{ price_labels|safe }},
  price_data: {{ price_data|safe }},
  priceHistoryUrl: '{% url "get_price_history" username=username %}'
};
</script>
<script src="{% static 'js/user_dashboard.js' %}"></script>
<!-- Price History Modal -->
<div class="modal fade" id="priceHistoryModal" tabindex="-1" aria-labelledby="priceHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="priceHistoryModalLabel">
          <i class="fas fa-chart-line"></i>
          Detail Perubahan Harga
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="priceHistoryContent">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Memuat data perubahan harga...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
