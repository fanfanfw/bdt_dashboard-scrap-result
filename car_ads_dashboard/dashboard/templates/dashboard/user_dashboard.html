{% extends "dashboard/base_user.html" %}
{% load humanize %}
{% block title %}Dashboard - {{ source|capfirst }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h4 class="mb-4 text-center">Dashboard - {{ source|capfirst }}</h4>

  <!-- Row 1: KPI Cards -->
  <div class="row mb-4 text-center">
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6>Total Semua Listing</h6>
          <h3 class="text-primary" id="totalAll">{{ total_all|intcomma }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6>Total Listing Aktif</h6>
          <h3 class="text-success" id="totalActive">{{ total_active|intcomma }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6>Total Listing Terjual</h6>
          <h3 class="text-warning" id="totalSold">{{ total_sold|intcomma }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6>Total Brand</h6>
          <h3 class="text-info" id="totalBrand">{{ total_brand|intcomma }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 2: Charts -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header">
          10 Brand dengan Iklan Terbanyak
        </div>
        <div class="card-body">
          <canvas id="brandBarChartAds"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header">
          10 Brand dengan Penjualan Terbanyak
        </div>
        <div class="card-body">
          <canvas id="brandBarChartSold"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 3: Placeholder for additional charts -->
  <div class="row">
    <!-- Bisa ditambah chart lain seperti tren harga, distribusi tahun, dsb -->
  </div>
</div>

<!-- JQuery dan Chart.js CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Chart Iklan Terbanyak
  const ctxAds = document.getElementById('brandBarChartAds').getContext('2d');
  let brandBarChartAds = new Chart(ctxAds, {
    type: 'bar',
    data: {
      labels: {{ chart_labels_ads|safe }},
      datasets: [{
        label: 'Jumlah Iklan',
        data: {{ chart_data_ads|safe }},
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderRadius: 10,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, title: { display: true, text: '10 Brand Teratas - Iklan' }},
      scales: { y: { beginAtZero: true } }
    }
  });

  // Chart Penjualan Terbanyak
  const ctxSold = document.getElementById('brandBarChartSold').getContext('2d');
  let brandBarChartSold = new Chart(ctxSold, {
    type: 'bar',
    data: {
      labels: {{ chart_labels_sold|safe }},
      datasets: [{
        label: 'Jumlah Terjual',
        data: {{ chart_data_sold|safe }},
        backgroundColor: 'rgba(75, 192, 192, 0.7)',
        borderRadius: 10,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, title: { display: true, text: '10 Brand Teratas - Penjualan' }},
      scales: { y: { beginAtZero: true } }
    }
  });

  // Fungsi update dashboard (KPI + charts)
  function updateDashboard(data) {
    $('#totalAll').text(data.total_all.toLocaleString());
    $('#totalActive').text(data.total_active.toLocaleString());
    $('#totalSold').text(data.total_sold.toLocaleString());
    $('#totalBrand').text(data.total_brand.toLocaleString());

    // Update Chart Iklan Terbanyak
    brandBarChartAds.data.labels = data.chart_labels_ads;
    brandBarChartAds.data.datasets[0].data = data.chart_data_ads;
    brandBarChartAds.update();

    // Update Chart Penjualan Terbanyak
    brandBarChartSold.data.labels = data.chart_labels_sold;
    brandBarChartSold.data.datasets[0].data = data.chart_data_sold;
    brandBarChartSold.update();
  }


  // Event handler submit form dengan AJAX
  $('#filterForm').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();

    $.ajax({
      url: "{% url 'user_dashboard_data' username %}",
      method: "GET",
      data: formData,
      dataType: "json",
      success: function(response) {
        if (!response.error) {
          updateDashboard(response);
        } else {
          alert("Error: " + response.error);
        }
      },
      error: function() {
        alert("Gagal mengambil data dashboard.");
      }
    });
  });
</script>
{% endblock %}
