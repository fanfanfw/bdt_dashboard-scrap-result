{% extends "dashboard/base_user.html" %}
{% load humanize %}
{% block title %}Dashboard - {{ source|capfirst }}{% endblock %}

{% block content %}

<div class="container-fluid py-4">
  <h4 class="mb-4 text-center">Dashboard - {{ source|capfirst }}</h4>

  <!-- Row 1: KPI Cards -->
  <div class="d-flex flex-wrap gap-3 justify-content-center mb-4">
    <div class="kpi-card card shadow-sm mb-0 kpi-gradient-blue">
      <div class="card-body d-flex flex-column align-items-center">
        <div class="kpi-icon mb-2">
          <!-- Total Semua Listing Icon -->
          <svg width="32" height="32" fill="#2563eb" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 8h14v-2H7v2zm0-4h14v-2H7v2zm0-6v2h14V7H7z"/></svg>
        </div>
        <h6 class="kpi-label">Total Semua Listing</h6>
        <div class="kpi-value text-primary">{{ total_all|intcomma }}</div>
      </div>
    </div>
    <div class="kpi-card card shadow-sm mb-0 kpi-gradient-green">
      <div class="card-body d-flex flex-column align-items-center">
        <div class="kpi-icon mb-2">
          <!-- Aktif Icon -->
          <svg width="32" height="32" fill="#059669" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm-1 15-5-5 1.41-1.41L11 13.17l5.59-5.59L18 9l-7 8z"/></svg>
        </div>
        <h6 class="kpi-label">Total Listing Aktif</h6>
        <div class="kpi-value text-success">{{ total_active|intcomma }}</div>
      </div>
    </div>
    <div class="kpi-card card shadow-sm mb-0 kpi-gradient-yellow">
      <div class="card-body d-flex flex-column align-items-center">
        <div class="kpi-icon mb-2">
          <!-- Terjual Icon -->
          <svg width="32" height="32" fill="#eab308" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15l-5-5 1.41-1.41L11 13.17l5.59-5.59L18 9l-7 8z"/></svg>
        </div>
        <h6 class="kpi-label">Total Listing Terjual</h6>
        <div class="kpi-value text-warning">{{ total_sold|intcomma }}</div>
      </div>
    </div>
    <div class="kpi-card card shadow-sm mb-0 kpi-gradient-cyan">
      <div class="card-body d-flex flex-column align-items-center">
        <div class="kpi-icon mb-2">
          <!-- Brand Icon -->
          <svg width="32" height="32" fill="#06b6d4" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 17.93c-2.83.48-5.78-.3-7.93-2.44C2.37 15.13 2 13.62 2 12c0-1.62.37-3.13 1.07-4.49C6.22 3.37 9.17 2.59 12 3.07V19.93z"/></svg>
        </div>
        <h6 class="kpi-label">Total Brand</h6>
        <div class="kpi-value text-info">{{ total_brand|intcomma }}</div>
      </div>
    </div>
    <div class="kpi-card card shadow-sm mb-0 kpi-gradient-red">
      <div class="card-body d-flex flex-column align-items-center">
        <div class="kpi-icon mb-2">
          <!-- Data Terbaru Icon -->
          <svg width="32" height="32" fill="#dc2626" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H5V8h14v13zm0-15H5V5h14v1z"/></svg>
        </div>
        <h6 class="kpi-label">Data Terbaru Hari Ini</h6>
        <div class="kpi-value text-danger">{{ total_today|intcomma }}</div>
      </div>
    </div>
  </div>
  <style>
    :root {
      --color-bg: #DDDDDD;
      --color-dark: #222831;
      --color-blue: #30475E;
      --color-red: #F05454;
      --color-card: #fff;
      --color-card-header: #30475E;
      --color-card-shadow: 0 2px 12px 0 rgba(48,71,94,0.07);
      --color-canvas: #fff;
      --color-label: #30475E;
      --color-value: #222831;
    }
    body { background: var(--color-bg); }
    .kpi-card {
      background: var(--color-card);
      box-shadow: var(--color-card-shadow);
    }
    .kpi-label { color: var(--color-label); }
    .kpi-value { color: var(--color-value); }
    .modern-card {
      background: linear-gradient(135deg, #e8eaef 0%, #f3f4f7 100%);
      box-shadow: var(--color-card-shadow);
      border: none;
    }
    .modern-card .card-header {
      color: var(--color-card-header);
      background: transparent;
    }
    .modern-canvas {
      background: var(--color-canvas);
    }
    /* KPI Card Gradients with palette */
    .kpi-gradient-blue { background: linear-gradient(135deg, #30475E 0%, #DDDDDD 100%); }
    .kpi-gradient-green { background: linear-gradient(135deg, #4ed19e 0%, #DDDDDD 100%); }
    .kpi-gradient-yellow { background: linear-gradient(135deg, #ffe066 0%, #DDDDDD 100%); }
    .kpi-gradient-cyan { background: linear-gradient(135deg, #6ec6f0 0%, #DDDDDD 100%); }
    .kpi-gradient-red { background: linear-gradient(135deg, #F05454 0%, #DDDDDD 100%); }
    /* Dark mode palette */
    .dark-mode {
      --color-bg: #222831;
      --color-dark: #222831;
      --color-blue: #30475E;
      --color-red: #F05454;
      --color-card: #232a36;
      --color-card-header: #F05454;
      --color-card-shadow: 0 2px 12px 0 rgba(48,71,94,0.18);
      --color-canvas: #232a36;
      --color-label: #F05454;
      --color-value: #DDDDDD;
    }
    .dark-mode body { background: var(--color-bg) !important; }
    .dark-mode .kpi-card, .dark-mode .modern-card { background: var(--color-card) !important; }
    .dark-mode .modern-card .card-header { color: var(--color-card-header) !important; }
    .dark-mode .modern-canvas { background: var(--color-canvas) !important; }
    .dark-mode .kpi-label { color: var(--color-label) !important; }
    .dark-mode .kpi-value { color: var(--color-value) !important; }
    .dark-mode .kpi-gradient-blue { background: linear-gradient(135deg, #30475E 0%, #222831 100%) !important; }
    .dark-mode .kpi-gradient-green { background: linear-gradient(135deg, #4ed19e 0%, #222831 100%) !important; }
    .dark-mode .kpi-gradient-yellow { background: linear-gradient(135deg, #ffe066 0%, #222831 100%) !important; }
    .dark-mode .kpi-gradient-cyan { background: linear-gradient(135deg, #6ec6f0 0%, #222831 100%) !important; }
    .dark-mode .kpi-gradient-red { background: linear-gradient(135deg, #F05454 0%, #222831 100%) !important; }
    .kpi-card {
      flex: 1 1 200px;
      max-width: 230px;
      min-width: 180px;
      border: none;
      border-radius: 1.2rem;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.07);
      background: #fff;
      position: relative;
      overflow: hidden;
    }
    .kpi-card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 6px 24px 0 rgba(0,0,0,0.13);
      z-index: 2;
    }
    .kpi-label {
      font-size: 1rem;
      font-weight: 600;
      color: #444;
      margin-bottom: 0.2rem;
      letter-spacing: 0.01em;
    }
    .kpi-value {
      font-size: 2.1rem;
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: 0.1rem;
      letter-spacing: 0.01em;
    }
    .kpi-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.04);
      border-radius: 50%;
      margin-bottom: 0.2rem;
    }
    .modern-card {
      border-radius: 1.2rem;
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.07);
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%);
      border: none;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    .modern-card .card-header {
      font-weight: 700;
      font-size: 1.1rem;
      background: transparent;
      border-bottom: none;
      color: #334155;
      letter-spacing: 0.01em;
      padding-top: 1rem;
      padding-bottom: 0.5rem;
    }
    .modern-card .card-body {
      padding: 1.2rem 1.5rem 1.5rem 1.5rem;
    }
    .modern-canvas {
      border-radius: 1rem !important;
      background: #fff;
      box-shadow: 0 1px 8px 0 rgba(0,0,0,0.04);
      padding: 0.5rem;
    }
    /* Chart.js tooltip & legend improvements */
    .chartjs-tooltip {
      border-radius: 0.7rem;
      background: #fff;
      color: #222;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
      padding: 0.7rem 1rem;
      font-size: 1rem;
    }
    @media (max-width: 900px) {
      .kpi-card { max-width: 100%; min-width: 140px; }
      .modern-card { padding: 0.5rem; }
    }
  </style>

  <!-- Row 2: Charts -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="modern-card card h-100 shadow-sm">
        <div class="card-header">
          10 Brand dengan Iklan Terbanyak
        </div>
        <div class="card-body">
          <canvas id="brandBarChartAds" class="modern-canvas"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="modern-card card h-100 shadow-sm">
        <div class="card-header">
          10 Brand dengan Penjualan Terbanyak
        </div>
        <div class="card-body">
          <canvas id="brandBarChartSold" class="modern-canvas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 3: Layout Custom -->
  <div class="row">
    <!-- Kolom Kiri: Pie Chart dan Distribusi Transmisi bertumpuk -->
    <div class="col-lg-4 d-flex flex-column gap-4">
      <div class="modern-card card shadow-sm flex-fill">
        <div class="card-header">Status Listing (Active vs Sold)</div>
        <div class="card-body d-flex justify-content-center align-items-center flex-grow-1">
          <canvas id="statusPieChart" class="modern-canvas" style="max-width: 250px; max-height: 250px;"></canvas>
        </div>
      </div>
      <div class="modern-card card shadow-sm flex-fill">
        <div class="card-header">Distribusi Transmisi</div>
        <div class="card-body">
          <canvas id="transmissionBarChart" class="modern-canvas"></canvas>
        </div>
      </div>
    </div>

    <!-- Kolom Kanan: Distribusi Tahun Produksi -->
    <div class="col-lg-8">
      <div class="modern-card card shadow-sm h-100 d-flex flex-column">
        <div class="card-header">Distribusi Tahun Produksi</div>
        <div class="card-body">
          <canvas id="yearHistogram" class="modern-canvas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 4: Layout Scatterplot kanan besar, grafik & tabel kiri bertumpuk -->
  <div class="row mt-4">
    <!-- Kolom Kiri: Grafik Rata-rata Mileage dan Tabel Korelasi bertumpuk -->
    <div class="col-lg-4 d-flex flex-column gap-4">
      <div class="modern-card card shadow-sm flex-fill">
        <div class="card-header">Rata-rata Mileage per Tahun</div>
        <div class="card-body">
          <canvas id="avgMileageYearChart" class="modern-canvas" style="min-height: 350px;"></canvas>
        </div>
      </div>
      <div class="modern-card card shadow-sm flex-fill" style="overflow-x:auto; max-height: 370px;">
        <div class="card-header">Korelasi Antar Fitur</div>
        <div class="card-body">
          <table class="table table-bordered" id="correlationTable">
            <thead>
              <tr>
                <th>Fitur</th>
                <th>Price</th>
                <th>Mileage</th>
                <th>Year</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data korelasi akan diisi JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Kolom Kanan: Scatter Plot Mileage vs Price -->
    <div class="col-lg-8">
      <div class="modern-card card shadow-sm mb-4">
        <div class="card-header d-flex flex-wrap align-items-center gap-3">
          <h5 class="mb-0 flex-grow-1">Mileage vs Price Scatter Plot</h5>
          <select id="scatterBrand" class="form-select form-select-sm w-auto" required>
            <option value="">-- Pilih Brand --</option>
            {% for b in brands %}
            <option value="{{ b }}">{{ b }}</option>
            {% endfor %}
          </select>
          <select id="scatterModel" class="form-select form-select-sm w-auto" disabled>
            <option value="">-- Pilih Model --</option>
          </select>
          <select id="scatterVariant" class="form-select form-select-sm w-auto" disabled>
            <option value="">-- Pilih Variant --</option>
          </select>
          <select id="scatterYear" class="form-select form-select-sm w-auto">
            <option value="">-- Pilih Year --</option>
          </select>
        </div>
        <div class="card-body">
          <canvas id="scatterPlot" class="modern-canvas" style="min-height: 500px;"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- ...existing code... -->

<!-- JQuery dan Chart.js CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ==== Chart Bar: Iklan Terbanyak ====
  const ctxAds = document.getElementById('brandBarChartAds').getContext('2d');
  let gradientAds = ctxAds.createLinearGradient(0, 0, 0, 400);
  gradientAds.addColorStop(0, '#30475E');
  gradientAds.addColorStop(1, '#DDDDDD');
  let brandBarChartAds = new Chart(ctxAds, {
    type: 'bar',
    data: {
      labels: {{ chart_labels_ads|safe }},
      datasets: [{
        label: 'Jumlah Iklan',
        data: {{ chart_data_ads|safe }},
        backgroundColor: gradientAds,
        borderRadius: 12,
        borderSkipped: false,
        hoverBackgroundColor: '#F05454',
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: true, text: '10 Brand Teratas - Iklan', font: { size: 18, weight: 'bold' }, color: '#30475E' }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: '#e5e7eb' }, ticks: { color: '#30475E' } },
        x: { grid: { display: false }, ticks: { color: '#30475E' } }
      }
    }
  });

  // ==== Chart Bar: Penjualan Terbanyak ====
  const ctxSold = document.getElementById('brandBarChartSold').getContext('2d');
  let gradientSold = ctxSold.createLinearGradient(0, 0, 0, 400);
  gradientSold.addColorStop(0, '#F05454');
  gradientSold.addColorStop(1, '#DDDDDD');
  let brandBarChartSold = new Chart(ctxSold, {
    type: 'bar',
    data: {
      labels: {{ chart_labels_sold|safe }},
      datasets: [{
        label: 'Jumlah Terjual',
        data: {{ chart_data_sold|safe }},
        backgroundColor: gradientSold,
        borderRadius: 12,
        borderSkipped: false,
        hoverBackgroundColor: '#30475E',
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: true, text: '10 Brand Teratas - Penjualan', font: { size: 18, weight: 'bold' }, color: '#F05454' }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: '#e5e7eb' }, ticks: { color: '#F05454' } },
        x: { grid: { display: false }, ticks: { color: '#F05454' } }
      }
    }
  });

  // ==== Chart Bar: Distribusi Tahun Produksi ====
  const yearCtx = document.getElementById('yearHistogram').getContext('2d');
  let gradientYear = yearCtx.createLinearGradient(0, 0, 0, 400);
  gradientYear.addColorStop(0, '#30475E');
  gradientYear.addColorStop(1, '#DDDDDD');
  const yearHistogram = new Chart(yearCtx, {
    type: 'bar',
    data: {
      labels: {{ years_hist_labels|safe }},
      datasets: [{
        label: 'Jumlah Listing',
        data: {{ years_hist_data|safe }},
        backgroundColor: gradientYear,
        borderRadius: 10,
        borderSkipped: false,
        hoverBackgroundColor: '#F05454',
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false }, title: { display: false } }, scales: { y: { grid: { color: '#e5e7eb' }, ticks: { color: '#30475E' } }, x: { grid: { display: false }, ticks: { color: '#30475E' } } } }
  });

  // ==== Chart Bar: Distribusi Transmisi ====
  const transmissionCtx = document.getElementById('transmissionBarChart').getContext('2d');
  let gradientTrans = transmissionCtx.createLinearGradient(0, 0, 0, 400);
  gradientTrans.addColorStop(0, '#30475E');
  gradientTrans.addColorStop(1, '#F05454');
  const transmissionBarChart = new Chart(transmissionCtx, {
    type: 'bar',
    data: {
      labels: {{ transmission_labels|safe }},
      datasets: [{
        label: 'Jumlah Listing',
        data: {{ transmission_data|safe }},
        backgroundColor: gradientTrans,
        borderRadius: 10,
        borderSkipped: false,
        hoverBackgroundColor: '#F05454',
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false }, title: { display: false } }, scales: { y: { grid: { color: '#e5e7eb' }, ticks: { color: '#30475E' } }, x: { grid: { display: false }, ticks: { color: '#30475E' } } } }
  });

  // ==== Pie Chart Status Listing ====
  const statusCtx = document.getElementById('statusPieChart').getContext('2d');
  const statusPieChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: ['Active', 'Sold'],
      datasets: [{
        data: [{{ total_active }}, {{ total_sold }}],
        backgroundColor: ['#30475E', '#F05454'],
        borderWidth: 2,
        borderColor: '#DDDDDD',
        hoverOffset: 10,
      }]
    },
    options: {
      cutout: '70%',
      responsive: true,
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 15, weight: 'bold' }, color: '#30475E' } },
        title: { display: true, text: 'Status Listing', font: { size: 18, weight: 'bold' }, color: '#30475E' },
        tooltip: { enabled: true, backgroundColor: '#fff', titleColor: '#222', bodyColor: '#222', borderColor: '#e5e7eb', borderWidth: 1 }
      }
    }
  });

  // ==== Scatter Plot Mileage vs Price + Dropdown cascading ====
  let scatterChart = null;

  function fetchModels(brand) {
    $('#scatterModel').prop('disabled', true).html('<option>Loading...</option>');
    $('#scatterVariant').prop('disabled', true).html('<option>-- Pilih Variant --</option>');
    $.ajax({
      url: "{% url 'get_models' %}",
      data: { brand: brand, source: "{{ source }}" },
      success: function(data) {
        let options = '<option value="">-- Pilih Model --</option>';
        data.models.forEach(m => options += `<option value="${m}">${m}</option>`);
        $('#scatterModel').html(options).prop('disabled', false);
      },
      error: function() {
        $('#scatterModel').html('<option value="">-- Error Load Model --</option>');
      }
    });
    // Update years dropdown
    fetchYears(brand, '', '');
  }

  function fetchVariants(brand, model) {
    $('#scatterVariant').prop('disabled', true).html('<option>Loading...</option>');
    $.ajax({
      url: "{% url 'get_variants' %}",
      data: { brand: brand, model: model, source: "{{ source }}" },
      success: function(data) {
        let options = '<option value="">-- Pilih Variant --</option>';
        data.variants.forEach(v => options += `<option value="${v}">${v}</option>`);
        $('#scatterVariant').html(options).prop('disabled', false);
      },
      error: function() {
        $('#scatterVariant').html('<option value="">-- Error Load Variant --</option>');
      }
    });
    // Update years dropdown
    fetchYears(brand, model, '');
  }

  function fetchYears(brand, model, variant) {
    $.ajax({
      url: "{% url 'get_years' %}",
      data: { brand: brand, model: model, variant: variant, source: "{{ source }}" },
      success: function(data) {
        let options = '<option value="">-- Pilih Year --</option>';
        if(data.years && data.years.length > 0) {
          data.years.forEach(y => options += `<option value="${y}">${y}</option>`);
        }
        const prev = $('#scatterYear').val();
        $('#scatterYear').html(options);
        // Jika tahun sebelumnya masih ada di list, tetap pilih
        if(prev && data.years.includes(parseInt(prev))) {
          $('#scatterYear').val(prev);
        }
      }
    });
  }

  function fetchScatterData(brand, model, variant, year) {
    $.ajax({
      url: "{% url 'get_scatter_data' username %}",
      data: { brand: brand, model: model, variant: variant, year: year, source: "{{ source }}" },
      success: function(data) {
        if(scatterChart) scatterChart.destroy();
        const chartData = data.map(item => ({
          x: item.mileage,
          y: item.price,
          label: `${item.brand} ${item.model} ${item.variant}`
        }));
        const ctx = document.getElementById('scatterPlot').getContext('2d');
        scatterChart = new Chart(ctx, {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Mileage vs Price',
              data: chartData,
              backgroundColor: 'rgba(54, 162, 235, 0.8)'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const point = context.raw;
                    return `${point.label}: Mileage ${point.x}, Price RM ${point.y}`;
                  }
                }
              }
            },
            scales: {
              x: { title: { display: true, text: 'Mileage (km)' }, beginAtZero: true },
              y: { title: { display: true, text: 'Price (RM)' }, beginAtZero: true }
            }
          }
        });
      },
      error: function() {
        alert('Gagal memuat data scatter plot.');
      }
    });
  }

  // ==== Grafik Rata-rata Mileage per Tahun ====
  let avgMileageYearChart = null;
  function renderAvgMileageChart(labels, data) {
    const ctx = document.getElementById('avgMileageYearChart').getContext('2d');
    if (avgMileageYearChart) avgMileageYearChart.destroy();
    avgMileageYearChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Avg Mileage',
          data: data,
          borderColor: 'rgba(75, 192, 192, 0.8)',
          backgroundColor: 'rgba(75, 192, 192, 0.3)',
          fill: true,
          tension: 0.3,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Mileage' } },
          x: { title: { display: true, text: 'Year' } }
        }
      }
    });
  }
  function loadAvgMileagePerYear(brand, model='', variant='', year='') {
    if(!brand) return;
    let url = `{% url 'get_avg_mileage_per_year' username %}?source={{ source }}&brand=${brand}`;
    if(model) url += `&model=${model}`;
    if(variant) url += `&variant=${variant}`;
    if(year) url += `&year=${year}`;
    
    $.getJSON(url, function(data) {
      if(data.years && data.avg_mileages) {
        renderAvgMileageChart(data.years, data.avg_mileages);
      }
    });
  }

  // ==== Render Tabel Korelasi Fitur ====
  function renderCorrelationTable(corr) {
    const tbody = $('#correlationTable tbody');
    tbody.empty();
    if(!corr) {
      tbody.append('<tr><td colspan="4" class="text-center">Data korelasi tidak tersedia</td></tr>');
      return;
    }
    const features = Object.keys(corr);
    features.forEach(rowFeature => {
      let rowHtml = `<tr><th>${rowFeature}</th>`;
      features.forEach(colFeature => {
        const val = corr[rowFeature][colFeature];
        // Tambah pengecekan jika val undefined/null
        const displayVal = (val !== undefined && val !== null) ? val.toFixed(3) : '-';
        const highlightClass = (val >= 0.7 || val <= -0.7) ? 'table-success' : '';
        rowHtml += `<td class="${highlightClass}">${displayVal}</td>`;
      });
      rowHtml += '</tr>';
      tbody.append(rowHtml);
    });
  }

  function loadFeatureCorrelation() {
    $.getJSON("{% url 'get_feature_correlation' username %}?source={{ source }}", function(data) {
      if(data.correlation) {
        renderCorrelationTable(data.correlation);
      } else {
        $('#correlationTable tbody').html('<tr><td colspan="4" class="text-center">Data korelasi tidak tersedia</td></tr>');
      }
    }).fail(function() {
      $('#correlationTable tbody').html('<tr><td colspan="4" class="text-center text-danger">Gagal memuat data korelasi</td></tr>');
    });
  }

  $(document).ready(function() {
    loadFeatureCorrelation();
  });

  // ==== Init semua ====
  $(document).ready(function() {
    $('#scatterBrand').change(function() {
      const brand = $(this).val();
      const year = $('#scatterYear').val();
      if(brand) {
        fetchModels(brand);
        fetchScatterData(brand, '', '', year);
        loadAvgMileagePerYear(brand, '', '', year);
        // Reset model, variant, dan year
        $('#scatterModel').val('');
        $('#scatterVariant').val('');
        fetchYears(brand, '', '');
      } else {
        $('#scatterModel').prop('disabled', true).html('<option>-- Pilih Model --</option>');
        $('#scatterVariant').prop('disabled', true).html('<option>-- Pilih Variant --</option>');
        $('#scatterYear').html('<option value="">-- Pilih Year --</option>');
        if(scatterChart) scatterChart.destroy();
        if(avgMileageYearChart) avgMileageYearChart.destroy();
      }
    });

    $('#scatterModel').change(function() {
      const brand = $('#scatterBrand').val();
      const model = $(this).val();
      const year = $('#scatterYear').val();
      if(model) {
        fetchVariants(brand, model);
        fetchScatterData(brand, model, '', year);
        loadAvgMileagePerYear(brand, model, '', year);
        // Reset variant dan year
        $('#scatterVariant').val('');
        fetchYears(brand, model, '');
      } else {
        $('#scatterVariant').prop('disabled', true).html('<option>-- Pilih Variant --</option>');
        fetchScatterData(brand, '', '', year);
        loadAvgMileagePerYear(brand, '', '', year);
        fetchYears(brand, '', '');
      }
    });

    $('#scatterVariant').change(function() {
      const brand = $('#scatterBrand').val();
      const model = $('#scatterModel').val();
      const variant = $(this).val();
      const year = $('#scatterYear').val();
      fetchScatterData(brand, model, variant, year);
      loadAvgMileagePerYear(brand, model, variant, year);
      fetchYears(brand, model, variant);
    });

    $('#scatterYear').change(function() {
      const brand = $('#scatterBrand').val();
      const model = $('#scatterModel').val();
      const variant = $('#scatterVariant').val();
      const year = $(this).val();
      fetchScatterData(brand, model, variant, year);
      loadAvgMileagePerYear(brand, model, variant, year);
    });
  });
</script>
{% endblock %}
